import{ARR_OF_FORB_SITES,emailUrl}from"../constants/data.js";import{querySelector,isChecked,addClass,removeClass,storageSet,storageGet,executeScriptHere,getPureURL,setBadgeText,resetBadgeText,nFormatter}from"../constants/functions.js";let IS_SUPERVISION_ACTIVE;const toggleThisWebSiteInp=querySelector("#toggleThisWebSiteInp"),toggleEasyInpThisWebSite=querySelector("#toggleEasyInpThisWebSite"),initTutorial=()=>{const e=querySelector(".tutorial"),t=querySelector(".tutorial__next"),s=()=>{addClass(e,"tutorial-hid"),querySelector(".insturctions").textContent="Instructions",setTimeout(()=>{addClass(e,"tutorial-non")},1e3),storageSet({tutorial:!1})};querySelector(".insturctions").textContent="Tutorial",removeClass(e,"tutorial-non"),querySelector(".tutorial__agree").onclick=(()=>(addClass(e,"tutorial-transp"),addClass(e,"tutorial-step_1"),!1)),querySelector(".tutorial__skip").onclick=(()=>(s(),!1)),querySelector(".tutorial_link-finish").onclick=(()=>(s(),!1)),querySelector(".tutorial_to_options").onclick=(()=>(chrome.runtime.openOptionsPage(),s(),!1)),t.onclick=(()=>(addClass(e,"tutorial-step_2"),t.onclick=(()=>(addClass(e,"tutorial-step_3"),t.onclick=(()=>(addClass(e,"tutorial-step_4"),t.onclick=(()=>(removeClass(e,"tutorial-transp"),addClass(e,"tutorial-finish"),!1)),!1)),!1)),!1))},showMessage=e=>{addClass(querySelector(e),"message-visible"),".message_forb"==e?querySelector(".message_forb__link").onclick=(()=>(chrome.runtime.openOptionsPage(),removeClass(querySelector(e),"message-visible"),!1)):".message_reload"==e&&(querySelector(".message_reload__link").onclick=(()=>(chrome.tabs.query({active:!0,currentWindow:!0},t=>{chrome.tabs.update(t[0].id,{url:t[0].url}),removeClass(querySelector(e),"message-visible")}),!1)))},initToggler=(e,t,s,r,a,o,i)=>{e.onchange=(c=>{chrome.tabs.query({active:!0,currentWindow:!0},c=>{const l=getPureURL(c[0]),n=c[0].id;IS_SUPERVISION_ACTIVE&&ARR_OF_FORB_SITES.includes(l)?(e.checked=!1,showMessage(".message_forb")):storageGet(s,c=>{const d=c[s];if(isChecked(e)){isChecked(toggleThisWebSiteInp)&&(i&&executeScriptHere("restoreEasy"),storageGet(r,e=>{const t=e[r].filter(e=>e!==l);storageSet({[r]:t})}),t.checked=!1,removeClass(querySelector(a),"desc-active")),i?setBadgeText("E")(n):setBadgeText("H")(n),executeScriptHere(i?"removeEasy":"removeHard"),executeScriptHere("showAll");const e=[...d,l];storageSet({[s]:e}),addClass(querySelector(o),"desc-active")}else{isChecked(toggleThisPageInp)||(executeScriptHere("restore"),resetBadgeText(n));const e=d.filter(e=>e!==l);storageSet({[s]:e}),removeClass(querySelector(o),"desc-active")}})})})};initToggler(toggleThisWebSiteInp,toggleEasyInpThisWebSite,"thisWebsiteWork","thisWebsiteWorkEasy",".desc-easy",".desc-hard",!1),initToggler(toggleEasyInpThisWebSite,toggleThisWebSiteInp,"thisWebsiteWorkEasy","thisWebsiteWork",".desc-hard",".desc-easy",!0);const toggleThisPageInp=querySelector("#toggleThisPageInp");toggleThisPageInp.onchange=(e=>{chrome.tabs.query({active:!0,currentWindow:!0},e=>{const t=getPureURL(e[0]);IS_SUPERVISION_ACTIVE&&ARR_OF_FORB_SITES.includes(t)?(toggleThisPageInp.checked=!1,showMessage(".message_forb")):isChecked(toggleThisPageInp)?(executeScriptHere("removeAll"),executeScriptHere("showAll"),chrome.tabs.sendMessage(e[0].id,{method:"setStatusThisPage",thisPageOn:!0}),addClass(querySelector(".desc-read"),"desc-active")):(isChecked(toggleThisWebSiteInp)||executeScriptHere("restoreEasy"),isChecked(toggleThisWebSiteInp)||isChecked(toggleEasyInpThisWebSite)||executeScriptHere("restore"),showMessage(".message_reload"),chrome.tabs.sendMessage(e[0].id,{method:"setStatusThisPage",thisPageOn:!1}),removeClass(querySelector(".desc-read"),"desc-active"))})});const updStats=()=>{storageGet(["stats"],e=>{querySelector(".stats__elem").innerHTML=nFormatter(e.stats.numbOfItems,1),querySelector(".stats__size").innerHTML=nFormatter(e.stats.cleanedArea,1)})},initState=()=>{storageGet(["tutorial","showUpdMess","statsEnabled","stats"],e=>{e.tutorial&&initTutorial(),e.statsEnabled&&(addClass(querySelector(".stats"),"stats-show"),querySelector(".stats__elem").innerHTML=nFormatter(e.stats.numbOfItems,1),querySelector(".stats__size").innerHTML=nFormatter(e.stats.cleanedArea,1),setInterval(updStats,1e3))}),chrome.tabs.query({active:!0,currentWindow:!0},e=>{let t=!1;const s=getPureURL(e[0]);storageGet("supervision",e=>{e.supervision?(IS_SUPERVISION_ACTIVE=!0,ARR_OF_FORB_SITES.includes(s)&&addClass(querySelector(".PopUpOFF"),"PopUpOFF-forb_site")):IS_SUPERVISION_ACTIVE=!1}),storageGet("thisWebsiteWork",e=>{e.thisWebsiteWork.includes(s)&&(querySelector("#toggleThisWebSiteInp").checked=!0,addClass(querySelector(".desc-hard"),"desc-active"),t=!0)}),storageGet("thisWebsiteWorkEasy",e=>{e.thisWebsiteWorkEasy.includes(s)&&!t&&(querySelector("#toggleEasyInpThisWebSite").checked=!0,addClass(querySelector(".desc-easy"),"desc-active"))}),chrome.tabs.sendMessage(e[0].id,{method:"getStatusThisPage"},e=>{e&&(querySelector("#toggleThisPageInp").checked=!0)})})};storageGet(["tutorial","showUpdMess","statsEnabled","stats"],e=>{e.tutorial&&initTutorial(),e.statsEnabled&&(addClass(querySelector(".stats"),"stats-show"),querySelector(".stats__elem").innerHTML=nFormatter(e.stats.numbOfItems,1),querySelector(".stats__size").innerHTML=nFormatter(e.stats.cleanedArea,1),setInterval(updStats,1e3))}),chrome.tabs.query({active:!0,currentWindow:!0},e=>{let t=!1;const s=getPureURL(e[0]);storageGet("supervision",e=>{e.supervision?(IS_SUPERVISION_ACTIVE=!0,ARR_OF_FORB_SITES.includes(s)&&addClass(querySelector(".PopUpOFF"),"PopUpOFF-forb_site")):IS_SUPERVISION_ACTIVE=!1}),storageGet("thisWebsiteWork",e=>{e.thisWebsiteWork.includes(s)&&(querySelector("#toggleThisWebSiteInp").checked=!0,addClass(querySelector(".desc-hard"),"desc-active"),t=!0)}),storageGet("thisWebsiteWorkEasy",e=>{e.thisWebsiteWorkEasy.includes(s)&&!t&&(querySelector("#toggleEasyInpThisWebSite").checked=!0,addClass(querySelector(".desc-easy"),"desc-active"))}),chrome.tabs.sendMessage(e[0].id,{method:"getStatusThisPage"},e=>{e&&(querySelector("#toggleThisPageInp").checked=!0)})});
